name: Deploy to AWS (S3 + optional CloudFront)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Sync static site to S3
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # for GitHub OIDC to assume an AWS role
      contents: read

    env:
      AWS_REGION: ${{ vars.AWS_REGION || secrets.AWS_REGION || 'us-east-1' }}
      S3_BUCKET: ${{ vars.S3_BUCKET || secrets.S3_BUCKET }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID || secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      AWS_ROLE_ARN: ${{ vars.AWS_ROLE_ARN || secrets.AWS_ROLE_ARN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Prefer using OIDC + role assumption (no long-lived keys).
      - name: Configure AWS credentials (OIDC role)
        if: env.AWS_ROLE_ARN != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # Fallback to access keys if role not provided.
      - name: Configure AWS credentials (access keys)
        if: env.AWS_ROLE_ARN == ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate required env
        run: |
          if [ -z "${S3_BUCKET}" ] ; then echo "S3_BUCKET is required (set as Repository Variable or Secret)"; exit 1; fi
          if [ -z "${AWS_REGION}" ] ; then echo "AWS_REGION is required (set as Repository Variable or Secret)"; exit 1; fi

      - name: Show target
        run: echo "Deploying to s3://${S3_BUCKET} in ${AWS_REGION}"

      # Ensure AWS CLI is available (use preinstalled CLI on runner)
      - name: Verify AWS CLI
        run: aws --version

      # Sync all files with long cache by default (immutable assets). We'll override html/sw/manifest below.
      - name: Sync site to S3 (long cache for assets)
        run: |
          aws s3 sync . s3://"$S3_BUCKET" \
            --delete \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "README.md" \
            --exclude "index.html" \
            --exclude "service-worker.js" \
            --exclude "manifest.webmanifest" \
            --cache-control "public, max-age=31536000, immutable" \
            --region "$AWS_REGION"

      - name: Upload index.html (no-store)
        run: |
          aws s3 cp index.html s3://"$S3_BUCKET"/index.html \
            --content-type "text/html; charset=utf-8" \
            --cache-control "no-store, no-cache, must-revalidate, proxy-revalidate" \
            --region "$AWS_REGION"

      - name: Upload service-worker.js (no-store)
        run: |
          aws s3 cp service-worker.js s3://"$S3_BUCKET"/service-worker.js \
            --content-type "application/javascript" \
            --cache-control "no-store, no-cache, must-revalidate, proxy-revalidate" \
            --region "$AWS_REGION"

      - name: Upload manifest.webmanifest (no-store)
        run: |
          aws s3 cp manifest.webmanifest s3://"$S3_BUCKET"/manifest.webmanifest \
            --content-type "application/manifest+json" \
            --cache-control "no-store, no-cache, must-revalidate, proxy-revalidate" \
            --region "$AWS_REGION"

      - name: Set content-type for SVG icon (optional)
        if: ${{ hashFiles('icons/logo.svg') != '' }}
        run: |
          aws s3 cp icons/logo.svg s3://"$S3_BUCKET"/icons/logo.svg \
            --content-type "image/svg+xml" \
            --cache-control "public, max-age=31536000, immutable" \
            --region "$AWS_REGION"

      - name: Create CloudFront invalidation (optional)
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --paths "/index.html" "/service-worker.js" "/manifest.webmanifest" \
            --region "$AWS_REGION"
